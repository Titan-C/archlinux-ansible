#! /bin/bash

# external program to supply the passphrase:
export BORG_PASSCOMMAND='pass show {{ backup.local.pass}}'

# Create Local Backups
echo $( date ) "Creating Local Backups ..."
REPOSITORY={{ backup.local.vault }}
borg create --verbose --stats --compression=lz4 \
     --progress --exclude '*.pyc' \
    $REPOSITORY::'{hostname}-{user}-{utcnow:%Y-%m-%dT%H:%M:%S}' \
    {{ backup.local.dirs }}

# Prune Local Backups
echo $( date ) "Pruning local repository ..."

borg prune --verbose --stats --list \
     --keep-daily 7 \
     --keep-weekly 4 \
     --keep-monthly 6 $REPOSITORY

# Pull Backup from alina
echo $( date ) "Creating Backups from alina ..."
pass=$(pass show {{ backup.remote.pass }})

REPOSITORY=ssh://me@localhost:10022/{{ backup.remote.vault }}

echo $( date ) "Opening connection ..."
ssh -R 10022:localhost:22 alina "echo 'starting borg ...'; \
sudo BORG_PASSPHRASE=$pass \
borg create --verbose --stats \
     --progress --exclude '*.pyc' \
    $REPOSITORY::'{hostname}-{user}-{utcnow:%Y-%m-%dT%H:%M:%S}' \
    {{ backup.remote.dirs }}


# Prune alina Backups
REPOSITORY={{ backup.remote.vault }}
export BORG_PASSCOMMAND='pass show {{ backup.remote.pass }}'
echo $( date ) "Pruning alina repository ..."
borg prune --verbose --stats --list \
     --keep-daily 7 \
     --keep-weekly 4 \
     --keep-monthly 6 $REPOSITORY
