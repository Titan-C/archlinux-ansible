---
- name: Copy pacman configuration file
  template: src=pacman.conf.j2 dest=/etc/pacman.conf

- name: Full system upgrade
  pacman:
    update_cache: yes
    upgrade: yes

- name: Install shells
  include_tasks: shell.yml

- name: Install universal base packages
  pacman:
    state: present
    name:
      - binutils
      - python
      - rsync
      - tree
      - mlocate
      - htop
  tags:
    - packages

- name: Ensure locale en_US.UTF-8 locale is present
  locale_gen:
    name: en_US.UTF-8
    state: present
- name: Set local en_US.UTF-8 locale systemwide
  copy:
    dest: "/etc/locale.conf"
    content: "LANG=en_US.UTF-8"

- name: set timezone to Europe/Berlin
  timezone:
    name: Europe/Berlin

- name: Power saving setup
  include_tasks: power.yml
  when: inventory_hostname in groups['laptop']

- name: Hardware
  include_tasks: hardware.yml
  when: inventory_hostname in groups['laptop']

- name: Install borg
  pacman:
    state: present
    name:
      - python-llfuse
      - borg

- name: Create backup user
  user: name=borgbackup state=present
  tags: back

- name: Create backup repository
  file: state=directory path=/home/borgbackup/repos mode="0750" owner=borgbackup group=borgbackup
  tags: back

- name: Set authorized key taken from file
  authorized_key:
    user: borgbackup
    state: present
    key: "{{ item }}"
    key_options: 'command="borg serve --restrict-to-path /home/borgbackup/repos/",restrict'
  with_file:
    - nitro_smart.pub
    - ingrid_root.pub
  tags: back
